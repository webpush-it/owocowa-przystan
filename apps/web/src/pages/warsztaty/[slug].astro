---
import Layout from '../../layouts/Layout.astro'
import { PortableText } from "astro-portabletext"
import { sanityClient, urlFor } from '../../lib/sanity'
import PortableTextImage from '../../components/PortableTextImage.astro'

export async function getStaticPaths() {
    const query = `*[_type == "workshop"]{ "slug": slug.current }`
    const workshops = await sanityClient.fetch(query)

    // Obsługa przypadku bez danych w CMS (dla demo)
    if (!workshops.length) {
        return [{ params: { slug: 'w-poszukiwaniu-owadow' } }]
    }

    return workshops.map((workshop: any) => ({
        params: { slug: workshop.slug },
    }))
}

const { slug } = Astro.params

// Pobranie pełnych danych
const query = `*[_type == "workshop" && slug.current == $slug][0]{
    ...,
    "leafletUrl": leaflet.asset->url
}`
let workshop = await sanityClient.fetch(query, { slug })

// Konfiguracja komponentów dla treści (żeby zdjęcia w tekście działały)
const components = {
    type: {
        image: PortableTextImage,
    },
};
---

<Layout title={workshop.title}>
    <div class="container mx-auto px-4 py-6 md:py-12 max-w-4xl">
        <a href="/oferta" class="inline-flex items-center text-op-green-dark hover:text-op-red mb-6 transition">
            ← Powrót do oferty
        </a>

        <h1 class="font-serif text-4xl md:text-5xl font-bold text-op-brown mb-6">{workshop.title}</h1>

        {workshop?.mainImage && (
            <img
                src={urlFor(workshop.mainImage).width(1200).height(600).url()}
                alt={workshop.title}
                class="w-full h-auto rounded-2xl shadow-lg mb-12"
            />
        )}

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-6 md:mb-12">
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 col-span-3">
                <h2 class="font-bold text-xl mb-4 text-op-green-dark">O zajęciach</h2>
                <div class="text-gray-700 leading-relaxed mb-6">
                    <PortableText value={workshop.description} components={components} />
                </div>
                <h3 class="font-bold text-lg mb-3">Dodatkowe informacje:</h3>
                <div class="text-gray-700 leading-relaxed mb-6">
                    <PortableText value={workshop.additionalInfo} components={components} />
                </div>
            </div>

            <div class="space-y-6 col-span-2">
                <div class="bg-op-cream p-6 rounded-xl border border-op-green/30 h-full flex flex-col justify-between">
                    <div>
                    <h3 class="font-bold text-lg mb-4 border-b border-gray-200 pb-2">Szczegóły logistyczne</h3>
                        <ul class="space-y-3 text-sm mb-6">
                        <li><strong>Czas:</strong> {workshop.duration}</li>
                        <li><strong>Grupa:</strong> {workshop.targetGroup}</li>
                        <li><strong>Liczebność:</strong> {workshop.groupSize}</li>
                    </ul>
                </div>

                    {workshop.leafletUrl && (
                        <div class="border-t border-op-green/20 pt-6">
                            <a
                                href={workshop.leafletUrl}
                                target="_blank"
                                rel="noopener noreferrer"
                                class="inline-flex items-center justify-center bg-white border-2 border-op-green-dark text-op-green-dark px-6 py-3 rounded-xl font-bold hover:bg-op-green-dark hover:text-white transition-colors w-full sm:w-auto shadow-sm"
                            >
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                Pobierz ulotkę informacyjną
                            </a>
                        </div>
                    )}
                </div>
            </div>

            <div class="space-y-6 col-span-1">
                <div class="bg-op-red text-white p-6 rounded-xl text-center h-full flex flex-col justify-center">
                    <h3 class="font-bold text-lg mb-2">Zarezerwuj termin</h3>
                    <p class="text-sm mb-6 opacity-90">Zadzwoń lub napisz, aby ustalić szczegóły.</p>
                    <a href="/kontakt" class="inline-block bg-white text-op-red px-6 py-3 rounded-full font-bold hover:bg-gray-100 transition w-full shadow-md">
                        Skontaktuj się
                    </a>
                </div>
            </div>
        </div>
    </div>
</Layout>
